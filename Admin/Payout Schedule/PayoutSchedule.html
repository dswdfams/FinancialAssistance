

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="../Navigation-footer.css">
  <link rel="stylesheet" href="PayoutSchedule.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <title>Payout Schedule</title>
</head>

<body>
  <div class="maincont">
    <div class="nav">
      <div class="imagecont">
        <img src="DSWD-Logo-Icon.png" alt="" />
      </div>

      <div class="links">
        <ul>
          <li >
            <a href="../dashboards/Dashboard.html">
              <div>
                <img src="icons8-dashboard-48.png" alt="" />
                <label for="">Dashboard</label>
              </div>
            </a>
          </li>
          <li>
            <a href="../Activity log/ActivityLog.html">
              <div>
                <img src="icons8-verified-account-48.png" alt="" />
                <label for="">Activity Log</label>
              </div>
            </a>
          </li>
          <li>
            <a href="../Application report/Applicationreport.html">
              <div>
                <img src="../Admin imgs/icons8-system-task-48.png" alt="" />
                <label for="">Application report</label>
              </div>
            </a>
          </li>
          <li class="userManagement">
            <a href="../UserManagement/Usernanagement.html">
              <div>
                <img src="../Admin imgs/icons8-user-secured-48.png" alt="" />
                <label for="">User Management</label>
              </div>
            </a>
          </li>
          <li class="highlight">
            <a href="/Admin/Payout Schedule/PayoutSchedule.html">
              <div>
                <img src="icons8-schedule-100.png" alt="" />
                <label for="">Payout Schedule</label>
              </div>
            </a>
          </li>
          <li>
            <a href="/Admin/Payout history/PayoutHistory.html">
              <div>
              <img src="../Admin imgs/icons8-history-100.png"
            alt="" /><label>Payout History</label>
          </div></a></li>
        </li>
        <li class="logout">
          <a href="/Admin/Login/Admin Login.html">
         <div>
            <img src="icons8-logout-32.png" alt="" />
            <label for="">Logout</label>
          </div>
         </li>
        </a>
        </ul>
      </div>
    </div>

    <div class="parent-cardcont">
      <div class="title">
        <div class="childtitle">
          <p>Payout Schedule</p>
        </div>
        <div class="button">
          <div>
            <p id="roleDisplay">Role</p>
          </div>
          <div class="buttonimg"><img src="icons8-admin-26.png" alt="" /></div>
        </div>
      </div>

      <div class="searchparent-container">
        <div class="search-container">
          <img src="icons8-search-50.png" alt="Search Icon" class="search-icon" />
          <input type="text" class="search-input" placeholder="Search by name or ID..." />
        </div>

        <div class="Searchbar-buttons">
          <select id="assistanceTypeDropdown">
            <option value="" disabled selected>Select Assistance Type</option>
            <option value="AICS">Financial Assistance</option>
            <option value="SCA">Senior Citizen</option>
            <option value="EAR">Educational Assistance</option>
            <option value="PWD">PWD</option>
          </select>
        </div>
      </div>
<style>
.modal {
  display: none;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background-color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  width: 80%;
  max-width: 400px;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.modal-content button {
  margin: 10px;
  padding: 10px 20px;
  cursor: pointer;
}

.modal-content #confirmScheduleBtn,
.modal-content #confirmTransactionBtn {
  background-color:rgb(92, 198, 92);;
  color: white;
  border: none;
}

.modal-content #cancelScheduleBtn,
.modal-content #cancelTransactionBtn {
  background-color: red;
  color: white;
  border: none;
}


.request-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 10px;
  background-color: white;
  padding: 10px;

}

.request-table th,
td {
  padding: 10px;

  text-align: left;
  width: 10px;
  margin: 0px;
}

.request-table thead {
  background-color: #0c77a8;
  color: white;
  border-radius: 10px;
}

.request-table tr {
  box-shadow: 0 2px 5px grey;
  border-radius: 10px;


}

.request-table .action-btn {
  padding: 5px 10px;
  margin: 2px;
  cursor: pointer;
}

.request-table .delete {
  background-color: red;
  border-radius: 5px;
  border: none;
  color: white;
}

.request-table .accept {
  border-radius: 5px;
  border: none;
  background-color: #0c77a8;
  color: white;
}

.accept:hover {
  transform: scale(0.96);
}

.delete:hover {
  transform: scale(0.96);
}</style>
      <div class="maincardcont">
        <div class="card-container">
          <!-- AICS Table -->
          <div class="overflowcont" id="AICS" style="display: none;">
            <h3>Financial A ssistance</h3>
            <div class="Payout-div">
              <label for="payoutDateAICS">Payout Date: </label>
              <input type="date" id="payoutDate" />
              <button id="setPayoutSchedule">Set Payout Schedule</button>
            </div>
            <table class="request-table">
              <thead>
                <tr>
                    <th><input type="checkbox" class="selectAll" data-type="AICS" /></th>
                  <th>ID</th>
                  <th>lastName</th>
                  <th>firstName</th>                
                  <th>Payout Amount</th>
                  <th>Schedule</th>
                  <th>Status</th>
                  <th>Action</th>
                 
                </tr>
              </thead>
              <tbody id="FA-table"></tbody>
              <tfoot>
                <tr>
                  <td colspan="4">Total Payout:</td>
                  <td id="totalAICSAmount">0</td> <!-- Unique ID for AICS -->
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>

          
          <div class="overflowcont" id="SCA" style="display: none;">
            <h3>Senior Citizen</h3>
            <div class="Payout-div">
              <label for="payoutDateSCA">Payout Date: </label>
              <input type="date" id="payoutDate" />
              <button id="setPayoutSchedule">Set Payout Schedule</button>
            </div>
            <table class="request-table">
              <thead>
                <tr>
                  <th><input type="checkbox" class="selectAll" data-type="SCA" /></th>
                  <th>ID</th>
                  <th>lastName</th>
                  <th>firstName</th>                 
                  <th>Payout Amount</th>
                  <th>Schedule</th>
                  <th>Status</th>
                  <th>Action</th>
                  
                </tr>
              </thead>
              <tbody id="SC-table"></tbody>
              <tfoot>
                <tr>
                  <td colspan="4">Total Payout:</td>
                  <td id="totalSCAAmount">0</td> 
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- EAR Table -->
          <div class="overflowcont" id="EAR" style="display: none;">
            <h3>Educational Assistance</h3>
            <div class="Payout-div" >
              <label for="payoutDateEAR">Payout Date: </label>
              <input type="date" id="payoutDate" />
              <button id="setPayoutSchedule">Set Payout Schedule</button>
            </div>
            <table class="request-table">
              <thead>
                <tr>
                  <th><input type="checkbox" class="selectAll" data-type="EAR" /></th>
                  <th>ID</th>
                  <th>lastName</th>
                  <th>firstName</th>                 
                  <th>Payout Amount</th>
                  <th>Schedule</th>
                  <th>Status</th>
                  <th>Action</th>
                 
                </tr>
              </thead>
              <tbody id="EA-table"></tbody>
              <tfoot>
                <tr>
                  <td colspan="4">Total Payout:</td>
                  <td id="totalEARAmount">0</td> 
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- PWD Table -->
          <div class="overflowcont" id="PWD" style="display: none;">
            <h3>PWD Assistance</h3>
            <div class="Payout-div">
              <label for="payoutDatePWD">Payout Date: </label>
              <input type="date" id="payoutDate" />
              <button id="setPayoutSchedule">Set Payout Schedule</button>
            </div>
            <table class="request-table">
              <thead>
                <tr>
                  <th><input type="checkbox" class="selectAll" data-type="PWD" /></th>
                  <th>ID</th>
                  <th>lastName</th>
                  <th>firstName</th>                 
                  <th>Payout Amount</th>
                  <th>Status</th>
                  <th>Schedule</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="PWD-table"></tbody>
              <tfoot>
                <tr>
                  <td colspan="4">Total Payout:</td>
                  <td id="totalPWDAmount">0</td> <!-- Unique ID for AICS -->
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>

<!-- Confirmation Modal for Setting Schedule -->
<div id="scheduleConfirmModal" class="modal" style="display:none;">
  <div class="modal-content">
    <p>Are you sure you want to set this payout schedule?</p>
    <button id="confirmScheduleBtn">Confirm</button>
    <button id="cancelScheduleBtn">Cancel</button>
  </div>
</div>

<!-- Confirmation Modal for Transaction Done -->
<div id="transactionConfirmModal" class="modal" style="display:none;">
  <div class="modal-content">
    <p>Are you sure you want to finish the transaction for this applicant?</p>
    <button id="confirmTransactionBtn">Confirm</button>
    <button id="cancelTransactionBtn">Cancel</button>
  </div>
</div>

 

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <script>
    // Role-Based Visibility and Display
  const userRole = sessionStorage.getItem('userRole');
  const roleDisplay = document.getElementById('roleDisplay');
  const userManagementLink = document.querySelector('.userManagement');
  const settingsLink = document.querySelector('.settings-link');
  
  if (userRole) {
    roleDisplay.textContent = `${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;
    if (userRole === 'staff') {
      if (userManagementLink) userManagementLink.style.display = 'none';
      if (settingsLink) settingsLink.style.display = 'none';
    }
  } else {
    console.warn('User role not found in sessionStorage.');
    roleDisplay.textContent = 'Unknown Role';
  }
  
  const firebaseConfig = {
    apiKey: "AIzaSyDiOsr6bY5BDKdiBPRzDgSpurHdkkUlc3k",
    authDomain: "sia101-d60a1.firebaseapp.com",
    databaseURL: "https://sia101-d60a1-default-rtdb.firebaseio.com",
    projectId: "sia101-d60a1",
    storageBucket: "sia101-d60a1.appspot.com",
    messagingSenderId: "258109532727",
    appId: "1:258109532727:web:73d735dc749d2cb4ebedb2",
  };
  
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  
  const assistanceTypes = ["AICS", "SCA", "EAR", "PWD"];
  const tableBodies = {
    AICS: document.getElementById("FA-table"),
    SCA: document.getElementById("SC-table"),
    EAR: document.getElementById("EA-table"),
    PWD: document.getElementById("PWD-table"),
  };
  
  const payoutAmounts = {
    AICS: 2000,
    SCA: 2000,
    EAR: 4000,
    PWD: 2000
  };
  
  // Load Accepted Applicants
function loadAcceptedApplicants(type) {
  const acceptedRef = database.ref("2-Accepted-Applications");

  acceptedRef.once("value", (snapshot) => {
    const data = snapshot.val();
    if (!data || !data[type]) {
      console.log(`No data found for ${type}`);
      document.getElementById(`total${type}Amount`).textContent = "0"; // Reset total to 0
      return;
    }

    tableBodies[type].innerHTML = ""; // Clear table
    let totalAmount = 0;

    Object.keys(data[type]).forEach((key) => {
      const assistanceData = data[type][key];
      const payoutSchedule = assistanceData.payoutSchedule || "";
      const row = `
        <tr>
          <td><input type="checkbox" class="selectApplicant" data-id="${key}" data-type="${type}" /></td>
          <td>${key}</td>
          <td>${assistanceData.lastName || "N/A"}</td>
          <td>${assistanceData.firstName || "N/A"}</td>
          <td>${payoutAmounts[type]}</td>
          <td>
          <input type="date" class="scheduleDate" data-id="${key}" data-type="${type}" value="${payoutSchedule}" />
          <button class="setScheduleBtn" data-id="${key}" data-type="${type}">Set Schedule</button>
          </td>
          <td>${assistanceData.status || ""}</td>
          <td><button class="transaction-btn" data-id="${key}" data-type="${type}">Transaction Done</button></td>
        </tr>`;
      tableBodies[type].innerHTML += row;
      totalAmount += payoutAmounts[type];
    });

    document.getElementById(`total${type}Amount`).textContent = totalAmount;
  });
}

// Handle "Set Payout Schedule" with Confirmation
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("setScheduleBtn")) {
    const button = e.target;
    const row = button.closest("tr");
    const scheduleDateInput = row.querySelector(".scheduleDate");
    const scheduleDate = scheduleDateInput.value;

    if (!scheduleDate) {
      alert("Please select a valid payout date.");
      return;
    }

    // Show confirmation modal
    const scheduleConfirmModal = document.getElementById("scheduleConfirmModal");
    scheduleConfirmModal.style.display = "block";

    // Attach event listeners for modal buttons
    document.getElementById("confirmScheduleBtn").onclick = () => {
      const applicantId = button.dataset.id;
      const assistanceType = button.dataset.type;

      // Update Firebase
      const applicationRef = database.ref(`2-Accepted-Applications/${assistanceType}/${applicantId}`);
      applicationRef
        .update({ payoutSchedule: scheduleDate })
        .then(() => {
          alert(`Payout schedule for applicant ${applicantId} set to ${scheduleDate}.`);
        })
        .catch((error) => {
          console.error(`Error setting schedule for ${applicantId}:`, error);
          alert(`Failed to set the schedule for ${applicantId}.`);
        });

      // Close modal
      scheduleConfirmModal.style.display = "none";
    };

    document.getElementById("cancelScheduleBtn").onclick = () => {
      scheduleConfirmModal.style.display = "none"; // Close modal
    };
  }
});


// Handle Assistance Type Dropdown
document.getElementById("assistanceTypeDropdown").addEventListener("change", (e) => {
  const selectedType = e.target.value;
  if (selectedType) {
    assistanceTypes.forEach((type) => {
      const tableElement = document.getElementById(type);
      tableElement.style.display = type === selectedType ? "block" : "none";
    });

    loadAcceptedApplicants(selectedType);
  }
});

// Handle "Transaction Done" with Validation and Confirmation
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("transaction-btn")) {
    const button = e.target;
    const row = button.closest("tr");
    const scheduleDateInput = row.querySelector(".scheduleDate");
    const scheduleDate = scheduleDateInput.value;

    if (!scheduleDate) {
      alert("Cannot complete the transaction. Please set a payout date first.");
      return;
    }

    // Show confirmation modal
    const transactionConfirmModal = document.getElementById("transactionConfirmModal");
    transactionConfirmModal.style.display = "block";

    // Attach event listeners for modal buttons
    document.getElementById("confirmTransactionBtn").onclick = () => {
      const applicantId = button.dataset.id;
      const assistanceType = button.dataset.type;

      // Move applicant to Payout History
      const applicationRef = database.ref(`2-Accepted-Applications/${assistanceType}/${applicantId}`);
      const historyRef = database.ref(`2-Payout-History/${assistanceType}/${applicantId}`);

      applicationRef.once("value", (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const updatedData = { ...data, status: "Paid" };

          historyRef
            .set(updatedData)
            .then(() => {
              applicationRef.remove();
              alert(`Transaction for ${applicantId} marked as Paid and moved to Payout History.`);
              row.remove(); // Remove row from table
            })
            .catch((error) => {
              console.error(`Error processing ${applicantId}:`, error);
            });
        }
      });

      // Close modal
      transactionConfirmModal.style.display = "none";
    };

    document.getElementById("cancelTransactionBtn").onclick = () => {
      transactionConfirmModal.style.display = "none"; // Close modal
    };
  }
});


  </script>
</body>

</html>